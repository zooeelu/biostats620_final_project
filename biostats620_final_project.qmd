---
title: "biostats620_final_project"
---
## Packages Used
```{r}
library(tidyverse)
library(excessmort)
library(kableExtra)
library(lubridate)
library(MASS)
```

## Question 1: Population Sizes by Age Group and Sex

```{r}
dat <- puerto_rico_counts

#marginal counts, we may want to collapse some of these (maybe into 10 yr bins?)
t1 <- dat %>%
  group_by(agegroup, sex) %>%
  summarize(count = mean(population), .groups = "drop") %>%
  pivot_wider(names_from = sex, values_from = count, values_fill = 0)

kable(t1)

#stratified plots
dat %>% ggplot(aes(date, population)) + 
  geom_line(aes(color = agegroup)) +
  facet_wrap(~sex) +
  labs(title = "Population Size by Age Group and Gender",
       x = "Year",
       y = "Population",
       color = "Age Group") 

weekly_deaths <- dat %>%
  filter(year(date) < 2017) %>% 
  mutate(mmwr_week = epiweek(date), 
         mmwr_year = epiyear(date)) %>% 
  group_by(agegroup, sex, mmwr_week, mmwr_year) %>%
  summarise(total_deaths = sum(outcome, na.rm = TRUE), population = mean(population)) %>% 
  ungroup()

#adding a plot to comment on why older folks are sticking around longer
weekly_deaths |> 
  filter(mmwr_year < 2017) |>
  group_by(mmwr_year) %>%
  summarize(mortality = mean(total_deaths/population)*1000, year = mmwr_year) %>% 
  ggplot(aes(x=year, y= mortality)) +
  geom_line(color = 'blue') +
  labs(title = "Yearly Mortality Rates (per 1,000): 2002-2016",
       x = "Year",
       y = "Rate")

```

Considering the population size of Puerto Rico from 1985 to 2022, we see differing trends across age groups. For both males and females, the population size for older age groups is increasing, while younger age groups are decreasing. We see this particularly in the 0-4 age group for both sexes. 

When examining the general trend in mortality rates over time, we see a decrease from 1985 to 2016. This could help to explain why we see increased population sizes for older age groups, potentially due to healthier lifestyles and improvements in medical care access and quality. 

## Question 2: Expected mortality 

```{r}

t2 <- weekly_deaths %>% 
  # looking at trends/ estimate what a typical week looks like across years
  group_by(mmwr_week, agegroup, sex) %>% 
  summarise(mean_deaths = mean(total_deaths),
            sd = sd(total_deaths)) %>% 
  ungroup() 

kable(head(t2, 10))

# some age groups have similar trends
t2 %>% 
  ggplot(aes(x = mmwr_week, y = mean_deaths, color = sex)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = mean_deaths - sd,
                  ymax = mean_deaths + sd,
                  fill = sex), alpha = 0.2, color = NA) +
  facet_wrap(~ agegroup, scales = "free_y")

# creating a df with larger age groups
new_dat <- dat %>% 
  mutate(mmwr_week = epiweek(date), 
         mmwr_year = epiyear(date),
         agegroup_new = case_when(
           agegroup %in% c("0-4", "5-9", "10-14", "15-19", "20-24") ~ "0-24",
           agegroup %in% c("25-29", "30-34", "35-39", "40-44", "45-49",
                           "50-54", "55-59", "60-64") ~ "25-64",
           agegroup %in% c("65-69", "70-74", "75-79", "80-84") ~ "65-84",
           agegroup == "85-Inf" ~ "85+")) %>% 
  group_by(agegroup_new, sex, mmwr_week, mmwr_year) %>%
  summarise(total_deaths = sum(outcome, na.rm = TRUE),  population = mean(population)) %>% 
  ungroup()

t3 <- new_dat %>% 
  # looking at trends/ estimate what a typical week looks like across years
  group_by(mmwr_week, agegroup_new, sex) %>% 
  summarise(mean_deaths = mean(total_deaths),
            sd = sd(total_deaths)) %>% 
  ungroup() 

kable(head(t3, 10))

t3 %>% 
  ggplot(aes(x = mmwr_week, y = mean_deaths, color = sex)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = mean_deaths - sd,
                  ymax = mean_deaths + sd,
                  fill = sex), alpha = 0.2, color = NA) +
  facet_wrap(~ agegroup_new, scales = "free_y")
```

### Model Fitting:

#### Linear Model: 
```{r}
model_dataset <- new_dat %>% mutate(rate = total_deaths/population, age = as.factor(agegroup_new))
linear <- lm(rate ~ population + mmwr_week + age + sex, data = model_dataset)
summary(linear)

perc_negative <- mean(linear$fitted.values < 0)

#clusters in chart?
plot(linear, which = 1)
plot(linear, which = 2)
```

Fitting a linear model, we see issues such as violations of homoskedasticity (funnel shape) and normality (tails of qq plot). We also see negative predictions for a non-negative outcome (rate)

#### Log-Linear Model:
```{r}
#do we need year for both plots? or should we limit year?
log_linear <- glm(total_deaths ~ mmwr_week + agegroup_new + sex, 
                  offset = log(population), 
                  family = poisson, 
                  data = new_dat)

summary(log_linear)

#GOF: prob of observing this deviance value given the df
1-pchisq(log_linear$deviance, log_linear$df.residual)

```
We next fit a log-linear model with mmwr_week, age, and sex again as predictors. We again seek to predict weekly death rate, this time modeling total deaths and using an offset equal to population size for a given week, gender, age, and year. Univariate Wald tests show that each coefficient is significantly associated with our outcome of interest, and a comparison of null and residual deviances shows that our model fits significantly better than the intercept-only model (LRT: 1225348 on 5 degrees of freedom)

Goodness of Fit: Under the null, the residual deviance should be distributed as a $X^2$ random variable with degrees of freedom equal to the model's residual degrees of freedom, 15858. We observe a residual deviance value of 66290. The probability of observing such a residual deviance value given that the fit model holds is essentially zero, indicating a lack of model fit. 


#####Assessing for Overdispersion:
```{r}
#gaps in chart again?
plot(log_linear, which = 3)
overdisp <- log_linear$deviance/log_linear$df.residual
overdisp
```
There is an upward trend in the scale-location plot for predicted values vs standardized pearson residuals. In a well-fitting model, the ratio of residual deviance to the degrees of freedom should be approximately 1 since the poisson distribution assumes that the mean and variance are exactly equal. In this case, the ratio value is 4.18 indicating that overdispersion is present in our data and that we may be underestimating the standard error of our data. 

#### Negative Binomial Regression:
```{r}
neg_bin <- glm.nb(total_deaths ~ mmwr_week + agegroup_new + sex + offset(log(population)), 
                  link = log,
                  data = new_dat)

summary(neg_bin)

1-pchisq(neg_bin$deviance, neg_bin$df.residual)
```
Comparing this model with the log-linear model, we can see that the likelihood ratio statistic is now 304787 on 5 degrees of freedom, showing that this model has a better fit than the log-linear model. However, the probability of observing such a residual deviance value given that the fit model holds is still very low, indicating a lack of model fit despite its improvements over the log-linear model.

#### Check for Autocorrelation:
```{r}
#can do a correlation heat map here to justify hierarchical model
```






